<form>
  <label for="filing_status">Choose your Filing Status</label>
  <select name="filing_status" id="filing_status">
    <option value="single">Single</option>
    <option value="married_separately">Married, Filing Separately</option>
    <option value="married">Married, Filing Together</option>
  </select> <br><br>

  <div class="calculator-input-text">Salary: 
  </div> <input type="number" placeholder="0" class="calculate-form" onchange=check_min(this) id="salary"> <p class="calculator-validation-p" id="salary-p"></p><br>
  
  <div class="calculator-input-text">Capital Gains: </div>
  <input type="number" placeholder="0" class="calculate-form" id="capital-gains"><br>

  <h4 id="total_income"> </h4>
  <div class="calculator-input-text">Traditional 401k Contributions: </div> 
  <input type="number" placeholder="0" class="calculate-form" onchange=check_min(this) id="trad-401k"><p class="calculator-validation-p" id="trad-401k-p"></p><br>
  
  <div class="calculator-input-text">HSA Contributions: </div>
  <input type="number" placeholder="0" class="calculate-form" onchange=check_min(this) id="hsa"><p class="calculator-validation-p" id="hsa-p"></p><br>
  <!--<h4 id="magi"> </h4>-->
  <div class="calculator-input-text">Traditional IRA Contributions: </div>
  <input type="number" placeholder="0" class="calculate-form" onchange=check_min(this) id="trad-ira"><p class="calculator-validation-p" id="trad-ira-p"></p><br>
  
  <div class="calculator-input-text calculator-tooltip">
    <span class="calculator-tooltip-text"><a href="/posts/what-is-sli" target="_blank">Learn about the SLI Deduction here</a></span>
    Student Loan Interest Paid: 
  </div> <input type="number" placeholder="0" class="calculate-form" onchange=check_min(this) id="sli"><p class="calculator-validation-p" id="sli-p"></p><br>
  
  <h4 id="agi"> </h4>
  <div class="calculator-input-text calculator-tooltip">
    <span class="calculator-tooltip-text"><a href="/posts/what-is-medical-expense" target="_blank">Learn about medical expenses here</a></span>
    Medical Expenses: 
  </div> <input type="number" placeholder="0" class="calculate-form" onchange=check_min(this) id="medical-expenses"><p class="calculator-validation-p" id="medical-expenses-p"></p><br>
  <div class="calculator-input-text calculator-tooltip">
    <span class="calculator-tooltip-text"><a href="/posts/what-is-salt" target="_blank">Read about the SALT here</a></span>
    State and Local Tax (SALT): 
  </div> <input type="number" placeholder="0" class="calculate-form" onchange=check_min(this) id="salt"><p class="calculator-validation-p" id="salt-p"></p><br>
  <div class="calculator-input-text calculator-tooltip">
    <span class="calculator-tooltip-text"><a href="/posts/what-is-mortgage-interest" target="_blank">Learn about your mortgage interest here</a></span>
    Mortgage Interest Paid: 
  </div> <input type="number" placeholder="0" class="calculate-form" onchange=check_min(this) id="mortgage-interest"><p class="calculator-validation-p" id="mortgage-interest-p"></p><br>
  
  <h4 id="final_deduction"> </h4>
  <h4 id="taxable_income"> </h4>
  <h4 id="regular_income_tax"></h4>

  <br><label for="iso_forms_count" class="calculator-tooltip">
    <span class="calculator-tooltip-text"> If you did not exercise from any, you do not have AMT</span>
    How many different ISO Grants did you exercise from?</label>
  <select name="iso_forms_count" id="iso_forms_count">
    <option value="iso_forms_count_one">1</option>
    <option value="iso_forms_count_two">2</option>
    <option value="iso_forms_count_three">3</option>
  </select>

  <div id="iso-form-container-for-all">
    <div class ="iso-form-containers" id="iso-form-container-1">
      <br>
      <h5 class="iso-form-labels" id="iso-form-label-1"> Input the details of grant #1 below </h5>
      <div class="calculator-input-text">Shares Exercised: </div>
      <input type="number" placeholder="0" class="calculate-form" onchange=check_min(this) id="shares-exercised-1"><p class="calculator-validation-p calculator-validation-iso-forms-p" id="shares-exercised-1-p"></p><br>
      <div class="calculator-input-text">Strike Price: </div>
      <input type="number" placeholder="0.00" class="calculate-form" onchange=check_min(this) id="strike-price-1"><p class="calculator-validation-p calculator-validation-iso-forms-p" id="strike-price-1-p"></p><br>
      <div class="calculator-input-text">Fair Market Value: </div>
      <input type="number" placeholder="0.00" class="calculate-form" onchange=check_min(this) id="fmv-1"><p class="calculator-validation-p calculator-validation-iso-forms-p" id="fmv-1-p"></p><br>
      </div>

    <div class ="iso-form-containers" id="iso-form-container-2">
      <br>
      <h5 class="iso-form-labels" id="iso-form-label-2"> Input the details of grant #2 below </h5>
      <div class="calculator-input-text">Shares Exercised: </div>
      <input type="number" placeholder="0" class="calculate-form" onchange=check_min(this) id="shares-exercised-2"><p class="calculator-validation-p calculator-validation-iso-forms-p" id="shares-exercised-2-p"></p><br>
      <div class="calculator-input-text">Strike Price: </div>
      <input type="number" placeholder="0.00" class="calculate-form" onchange=check_min(this) id="strike-price-2"><p class="calculator-validation-p calculator-validation-iso-forms-p" id="strike-price-2-p"></p><br>
      <div class="calculator-input-text">Fair Market Value: </div>
      <input type="number" placeholder="0.00" class="calculate-form" onchange=check_min(this) id="fmv-2"><p class="calculator-validation-p calculator-validation-iso-forms-p" id="fmv-2-p"></p><br>
    </div>
    
    <div class ="iso-form-containers" id="iso-form-container-3">
      <br>
      <h5 class="iso-form-labels" id="iso-form-label-3"> Input the details of grant #3 below </h5>
      <div class="calculator-input-text">Shares Exercised: </div>
      <input type="number" placeholder="0" class="calculate-form" onchange=check_min(this) id="shares-exercised-3"><p class="calculator-validation-p calculator-validation-iso-forms-p" id="shares-exercised-3-p"></p><br>
      <div class="calculator-input-text">Strike Price: </div>
      <input type="number" placeholder="0.00" class="calculate-form" onchange=check_min(this) id="strike-price-3"><p class="calculator-validation-p calculator-validation-iso-forms-p" id="strike-price-3-p"></p><br>
      <div class="calculator-input-text">Fair Market Value: </div>
      <input type="number" placeholder="0.00" class="calculate-form" onchange=check_min(this) id="fmv-3"><p class="calculator-validation-p calculator-validation-iso-forms-p" id="fmv-3-p"></p><br>
    </div>
  </div>

  <h4 id="iso_spread_subtotal"> </h4>
  <h4 id="amti"> </h4>
  <h4 id="amt_deduction"> </h4>
  <h4 id="amti_final"> </h4>

  <br><input type="button" id="calculator-submit" onclick=calculate_taxes() value="Calculate my AMT!">
</form>

<h3> Results: </h3>
<h4 id="amt_tax_owed"> </h4>
<h4 id="tax_confirmation_phrase"> </h4>

<!--<h2 id="placeholder"></h2>-->

<script>

  // Dyanmic forms for ISO Spread Calculator.
  // Starts with 1 ISO Grant Form shown
  // Also clears the error / validation message after every change
  $(document).ready(function() {
    $('#iso-form-container-2').hide();
    $('#iso-form-container-3').hide();
    
    $('#iso_forms_count').change(function(){
      if ($(this).val() == "iso_forms_count_one") {
        $('#iso-form-container-3').hide();
        $('#iso-form-container-2').hide();
        $('#iso-form-container-1').show();
        $('.calculator-validation-iso-forms-p').text("");
      } else if ($(this).val() == "iso_forms_count_two") {
        $('#iso-form-container-3').hide();
        $('#iso-form-container-1').show();
        $('#iso-form-container-2').show();
        $('.calculator-validation-iso-forms-p').text("");
      } else if ($(this).val() == "iso_forms_count_three") {
        $('#iso-form-container-1').show();
        $('#iso-form-container-2').show();
        $('#iso-form-container-3').show();
        $('.calculator-validation-iso-forms-p').text("");
      }
    })
  })

    function check_min(input) {
      var input_id = document.getElementById(input.id).id;
      var p_id = input_id.concat('-p');
      if (input.value < 0) {
        input.value = "";
        document.getElementById(p_id).innerHTML = "This number must not be negative";
      } else {
        document.getElementById(p_id).innerHTML = "";
      }
    }

    function calculate_taxes() {

    // First clear any error / validation messages. Any further validation below will re-set them if needed
    var all_validation_messages = document.getElementsByClassName("calculator-validation-p");
    for (i=0;i<all_validation_messages.length;i++) {
      all_validation_messages[i].innerHTML = "";
    }

    // Get 'value' of filing status selected to use to set tax limitations by filing status
    var filing_status_obj = document.getElementById("filing_status");
    var filing_status = filing_status_obj.options[filing_status_obj.selectedIndex].value;
    
    if (filing_status == 'single') {
      var amt_deduction=72900;
      var amt_phase = 518400;
      var amt_tax_brackets = 197900;
      var standard_deduction=12400;
      var sli_phase = 70000;
      var sli_max = 85000;
      var sli_divider = 15000;
      //LOOK INTO WHETHER SINGLE PEOPLE CAN HAVE A FAMILY HSA;     
      var trad_401k_limit = 19500;
      var hsa_limit = 3550;
      var trad_ira_limit = 6000;
      var salt_deduction_limit = 10000;
      var reg_income_tax_bracket = [0,9875,40125,85525,163300,207350,518400];

    } else if (filing_status == 'married_separately') {
      var amt_deduction=56700;
      var amt_phase = 518400;
      var amt_tax_brackets = 98950;
      var standard_deduction=12400;
      var sli_phase = 0;
      var sli_max = 0;
      var sli_divider = 0;
      var trad_401k_limit = 19500;
      var hsa_limit = 7100;
      var trad_ira_limit = 6000;
      var salt_deduction_limit = 5000;
      var reg_income_tax_bracket = [0,9875,40125,85525,163300,207350,311025];

    } else if (filing_status == 'married') {
      var amt_deduction=113400;
      var amt_phase = 1036800;
      var amt_tax_brackets = 197900;
      var standard_deduction=24800;
      var sli_phase = 140000;
      var sli_max = 170000;
      var sli_divider = 30000;
      var trad_401k_limit = 39000;
      var hsa_limit = 7100;
      var trad_ira_limit = 12000;
      var salt_deduction_limit = 10000;
      var reg_income_tax_bracket = [0,19750,80250,171050,326600,414700,622050];

    }
    function empty_to_zero(num) {
      if (num.length == 0) num = 0;
      return num;
    }

    // Get all form inputs. For all null / empty inputs, assign value of 0
    var salary=empty_to_zero(document.getElementById("salary").value);
    var capital_gains=empty_to_zero(document.getElementById("capital-gains").value);
    var trad_401k=empty_to_zero(document.getElementById("trad-401k").value);
    var hsa=empty_to_zero(document.getElementById("hsa").value);
    var trad_ira=empty_to_zero(document.getElementById("trad-ira").value);
    var sli=empty_to_zero(document.getElementById("sli").value);
    var medical_expenses=empty_to_zero(document.getElementById("medical-expenses").value);
    var salt=empty_to_zero(document.getElementById("salt").value);
    var mortgage_interest=empty_to_zero(document.getElementById("mortgage-interest").value);

    var iso_form_count_obj = document.getElementById("iso_forms_count");
    var iso_form_count = iso_form_count_obj.options[iso_form_count_obj.selectedIndex].value;

    var shares_exercised_1=empty_to_zero(document.getElementById("shares-exercised-1").value);
    var strike_price_1=empty_to_zero(document.getElementById("strike-price-1").value);
    var fmv_1=empty_to_zero(document.getElementById("fmv-1").value);
    var shares_exercised_2=empty_to_zero(document.getElementById("shares-exercised-2").value);
    var strike_price_2=empty_to_zero(document.getElementById("strike-price-2").value);
    var fmv_2=empty_to_zero(document.getElementById("fmv-2").value);
    var shares_exercised_3=empty_to_zero(document.getElementById("shares-exercised-3").value);
    var strike_price_3=empty_to_zero(document.getElementById("strike-price-3").value);
    var fmv_3=empty_to_zero(document.getElementById("fmv-3").value);
    
    // Does some validation based on the number of ISO Grants selected when user hits 'Calculate'. 
    // Zeroes out any inputs from extra forms that were hidden
    if (iso_form_count == "iso_forms_count_one") {
      shares_exercised_2 = strike_price_2 = fmv_2 = shares_exercised_3 = strike_price_3 = fmv_3 = 0;
    } else if (iso_form_count == "iso_forms_count_two") {
      shares_exercised_3 = strike_price_3 = fmv_3 = 0;
    }

    // Calculate Total Income
    var total_income = parseFloat(salary) + parseFloat(capital_gains);
    
    // Make sure number is under 401k limit
    if (trad_401k > trad_401k_limit) {
      trad_401k = trad_401k_limit;
      document.getElementById("salt").value = trad_401k_limit;
      document.getElementById('trad-401k-p').innerHTML = "The 401k limit for your filing status is: " + trad_401k_limit;
    }
    // Make sure number is under HSA limit
    if (hsa > hsa_limit) {
      hsa = hsa_limit;
      document.getElementById("salt").value = hsa_limit;
      document.getElementById('hsa-p').innerHTML = "The HSA limit for your filing status is: " + hsa_limit;
    }

    // Make sure number is under Trad IRA limit
    if (trad_ira > trad_ira_limit) {
      trad_ira = trad_ira_limit;
      document.getElementById("salt").value = trad_ira_limit;
      document.getElementById('trad-ira-p').innerHTML = "The IRA limit for your filing status is: " + trad_ira_limit;
    }
    // MAGI - AGI but includes Trad IRA, SLI
    var magi = total_income - parseFloat(trad_401k) - parseFloat(hsa);

    if (magi > sli_max) {
      sli = 0;
    } else if (magi > sli_phase) {
      var sli_multiplier = (magi - sli_phase) / sli_divider;
      if (sli_multiplier > 1) {
        sli_multiplier = 1;
      } else if (sli_multiplier < 0) {
        sli_multiplier = 0;
      } else {
        sli_multiplier = sli_multiplier.toFixed(3);
      }
      
      sli_correction = parseFloat(sli) * parseFloat(sli_multiplier);
      sli = sli - parseFloat(sli_correction);
      sli = sli.toFixed(2);
    } 

    if (filing_status == 'married_separately') {
      document.getElementById("sli").value = 0;
      document.getElementById('sli-p').innerHTML = "You cannot take the student loan interest deduction as 'Married, Filing Separately'";
    }

    // Calculate AGI
    var agi = total_income - parseFloat(trad_401k) - parseFloat(hsa) - parseFloat(trad_ira) - parseFloat(sli);
    
    // Medical Expenses Deduction - only include if more than 10% of AGI, else 0
    if (medical_expenses > (agi * 0.1)) {
      medical_expenses = medical_expenses - (agi * 0.1);
    } else {
      medical_expenses = 0;
    }
    
    // Make sure SALT is under SALT limit
    if (salt > salt_deduction_limit) {
      salt = salt_deduction_limit;
      document.getElementById("salt").value = salt_deduction_limit;
      document.getElementById('salt-p').innerHTML = "The SALT limit for your filing status is: " + salt_deduction_limit;
    }
    // Standard vs Itemized Deduction
    var itemized_deduction = parseFloat(medical_expenses) + parseFloat(salt) + parseFloat(mortgage_interest) + parseFloat(sli);
    if (itemized_deduction > standard_deduction) {
      var regular_deduction_final = itemized_deduction;
      var deduction_category = 'Itemized Deduction';
    } else {
      var regular_deduction_final = standard_deduction;
      var deduction_category = 'Standard Deduction';
    }

    // Calculate Regular taxable income
    var taxable_income = agi - regular_deduction_final;
    
    // CALCULATE REGULAR TAXES
    var reg_income_tax_rate = [0.1,0.12,0.22,0.24,0.32,0.35,0.37];
    // Returns index of first tax bracket threshold greater than taxable_income, so subtract 1 (JS is index 0)
    var taxable_income_index = reg_income_tax_bracket.findIndex(function(number) {
        return number > taxable_income;
    }) - 1;
    
    var regular_income_tax = 0;
    for (var i = taxable_income_index; i >= 0; i--) {
        if (i == taxable_income_index) {
            regular_income_tax += reg_income_tax_rate[taxable_income_index] * (taxable_income - reg_income_tax_bracket[taxable_income_index]);
        } else {
            regular_income_tax += reg_income_tax_rate[i] * (reg_income_tax_bracket[i+1] - reg_income_tax_bracket[i]);
        }
    }

    // Calculate ISO Spread
    var iso_spread_subtotal_1 = parseFloat(shares_exercised_1) * (parseFloat(fmv_1) - parseFloat(strike_price_1));
    var iso_spread_subtotal_2 = parseFloat(shares_exercised_2) * (parseFloat(fmv_2) - parseFloat(strike_price_2));
    var iso_spread_subtotal_3 = parseFloat(shares_exercised_3) * (parseFloat(fmv_3) - parseFloat(strike_price_3));
    var iso_spread_subtotal = iso_spread_subtotal_1 + iso_spread_subtotal_2 + iso_spread_subtotal_3;
    // Calculate AMTI (before AMT exemption)
    if (deduction_category == 'Standard Deduction') {
      var amti = taxable_income + iso_spread_subtotal + standard_deduction;
    } else {
      var amti = taxable_income + iso_spread_subtotal + parseFloat(salt) + parseFloat(medical_expenses);

    }
    // AMT Deduction Calculation, including Phase Out
    if (amti > amt_phase) {
      amt_deduction = amt_deduction - (0.25 * (amti - amt_phase))
    }
    if (amt_deduction < 0) {
      amt_deduction = 0
    }
    var amti_final = amti - parseFloat(amt_deduction);
    
    // Caculate AMT Tax, including Brackets
    if (amti_final > amt_tax_brackets) {
      var amt_tax_owed = ((amti_final - amt_tax_brackets) * 0.28) + (amt_tax_brackets * 0.26);
    } else {
      var amt_tax_owed = amti_final * 0.26;
    }

    if (regular_income_tax >= amt_tax_owed) {
      var tax_confirmation_phrase = "Because your Regular Income Tax is more than your AMT, you do not need to pay any additional AMT!";
    } else {
      var tax_diff = amt_tax_owed - regular_income_tax;
      var tax_confirmation_phrase = `Because your AMT is greater than your Regular Income Tax, you will need to pay ${tax_diff} more in taxes this year`;
    }
    
    // AMT CREDIT?
    // DEPENDENT CREDIT?

    //if (!isNaN(agi)) {
        document.getElementById("total_income").innerHTML="Your Total Income is " + total_income;
        //document.getElementById("magi").innerHTML="MAGI is " + magi;
        document.getElementById("agi").innerHTML="Your Adjusted Gross Income (AGI) is " + agi;
        document.getElementById("final_deduction").innerHTML="You took the " + deduction_category + " and your deduction is " + regular_deduction_final;
        document.getElementById("taxable_income").innerHTML="Your Taxable Income is " + taxable_income;
        document.getElementById("regular_income_tax").innerHTML= "Your Regular Income Tax is: " + regular_income_tax;
        document.getElementById("iso_spread_subtotal").innerHTML="Your ISO Spread is " + iso_spread_subtotal;
        document.getElementById("amti").innerHTML="Your AMT Taxable Income (AMTI) is " + amti;
        document.getElementById("amt_deduction").innerHTML="Your AMT deduction is " + amt_deduction;
        document.getElementById("amti_final").innerHTML="Your Final AMT Taxable Income is " + amti_final;
        document.getElementById("amt_tax_owed").innerHTML="Your final AMT owed is " + amt_tax_owed;
        document.getElementById("tax_confirmation_phrase").innerHTML= tax_confirmation_phrase;
    //}
    }
</script>